<!-- üìÅ File: index.html -->
<!DOCTYPE html>
<!-- HTML -->
<html lang="en">
<!-- #region üè∑Ô∏è Head & Styles -->
<head>
  <!-- Meta -->
  <meta charset="utf-8" />
  <!-- Title -->
  <title>Skyesoft Portal</title>
  <!-- Favicon Link -->
  <link rel="icon" href="https://notyou61.github.io/skyesoft/favicon.ico" type="image/x-icon">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <!-- jQuery (required by DataTables) -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <!-- Style Include-->
  <link rel="stylesheet" href="assets/css/skyesoft-ui.css">
</head>
<!-- #endregion -->

<!-- #region üìù Body -->
<body>
  
  <!-- #region üè¢ Page Header -->
  <div class="board-section" id="pageHeader">
    <div style="display: flex; align-items: center; gap: 16px;">
      <img src="assets/images/christyLogo.png" alt="Christy Signs" style="max-height: 48px;" />
      <h1 style="font-size: 1.4em;">Skyesoft Portal</h1>
    </div>
    <div style="display: flex; flex-direction: column; align-items: flex-end; font-size: 0.9em; white-space: nowrap;">
      <div>üå¶Ô∏è Weather: <span id="weatherDisplay">N/A</span></div>
      <div>‚è∞ Time: <span id="currentTime">--:--:--</span></div>
      <div>üïí Interval Remaining: <span id="intervalRemainingData">--</span></div>
    </div>
  </div>
  <!-- #endregion -->

  <!-- #region üìã Main Dashboard Body -->
  <main class="board-section" id="pageBody">

    <!-- #region üìù Body Header -->
    <div class="bodyHeader" id="bodyHeader" style="font-size: 1.3em; font-weight: bold;">
      <h2 id="bodyHeaderCopy">üîí User Log In</h2>
    </div>
    <!-- #endregion -->

    <div id="bodyMain">
      <!-- #region üóûÔ∏è News & Updates Section -->
      <div class="board-panel news-updates">
        <h3>üóûÔ∏è News & Updates</h3>
        <ul>
          <li>‚úÖ Phase 2 dashboard integration underway</li>
          <li>üß† AI Prompt logic in development</li>
          <li>üì¶ Project Tracker module upcoming</li>
        </ul>
      </div>
      <!-- #endregion -->

      <!-- #region üìä DataTable Section -->
      <div class="board-panel" style="margin-top: 16px;">
        <h3>üìã Project Summary</h3>
        <table id="projectTable" class="display" style="width:100%">
          <thead>
            <tr>
              <th>Project</th>
              <th>Status</th>
              <th>Jurisdiction</th>
              <th>Last Update</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Habit Burger #53452</td>
              <td>Approved</td>
              <td>City of Mesa</td>
              <td>06/18/25</td>
            </tr>
            <tr>
              <td>ALC Group Phoenix</td>
              <td>Scheduled</td>
              <td>City of Phoenix</td>
              <td>06/22/25</td>
            </tr>
            <!-- Add more rows as needed -->
          </tbody>
        </table>
      </div>
      <!-- #endregion -->

      <!-- #region üîë Login Section -->
      <div class="login-wrapper">
        <form class="login-form">
          <input type="text" placeholder="Username" name="username" required />
          <input type="password" placeholder="Password" name="password" required />
          <button type="submit" class="crud1">Log In</button>
          <div id="loginError" class="error-message"></div>
        </form>
      </div>
      <!-- #endregion -->
    </div>

    <!-- #region üìé Page Body Footer -->
    <div class="bodyFooter" id="bodyFooter" style="font-size: 0.9em; color: #666; padding-top: 8px;">
      <small>Need access? Contact your supervisor or email support@christysigns.com</small>
    </div>
    <!-- #endregion -->

  </main>
  <!-- #endregion -->

  <!-- #region ü¶∂ Page Footer -->
  <div class="board-section" id="pageFooter">
    <!-- Copyright -->
    <div>¬© 2025 Maychris Corporation</div>
    <!-- Version -->
    <div class="version">Loading version...</div>
  </div>
  <!-- #endregion -->

  <!-- #region ‚õÖ Weather & Utility Scripts -->
  <!-- Weather Config -->
  <script src="assets/js/weatherConfig.js"></script>
  <!-- Weather Functions -->
  <script src="assets/js/weather.js"></script>
  <!-- Login Script -->
  <script src="assets/js/login.js"></script>
  <!-- Markdown Renderer -->
  <script src="assets/js/marked.min.js"></script>
  <!-- Dynamic SSE Handler Script -->
  <script src="assets/js/dynamicSSEHandler.js"></script>
  <!-- #endregion -->

  <!-- #region ü§ñ Skyebot Modals and Floating Button -->
  <div id="modals">
    <!-- #region ü§ñ Skyebot Prompt Modal -->
    <div id="skyebotModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="toggleModal()">√ó</span>
        <h3>ü§ñ Skyebot</h3>
        <div id="chatLog" class="chat-log"></div>
        <form id="promptForm" class="chat-form">
          <textarea id="promptInput" rows="2" placeholder="Type your message..." required></textarea>
          <div class="form-footer">
            <div class="file-row">
              <label for="fileUpload" class="file-label">Choose Files</label>
              <input type="file" id="fileUpload" multiple onchange="updateFileLabel(this)">
              <div id="fileInfo" class="file-info">No files selected</div>
            </div>
            <div class="button-row">
              <button type="submit">Send</button>
              <button type="button" id="clearBtn" class="clear-btn">Clear</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <!-- #endregion -->
    <!-- #region ü§ñ Floating Prompt Button -->
    <button id="floatingChatBtn" onclick="toggleModal()" class="floating-btn" aria-label="Open Skyebot Prompt" style="display:none" >ü§ñ</button>
    <!-- #endregion -->
  </div>
  <!-- #endregion -->

  <!-- #region üìù Modal Script & UI Management -->
  <script>
    // #region ü§ñ Modal Visibility & Reset
    function toggleModal() {
      const modal = document.getElementById("skyebotModal");
      const isVisible = modal.style.display === "block";
      // #region üßπ Modal Reset On Close
      if (isVisible) {
        const chatLog = document.getElementById("chatLog");
        const promptInput = document.getElementById("promptInput");
        const fileInput = document.getElementById("fileUpload");
        const fileInfo = document.getElementById("fileInfo");
        if (chatLog) {
          chatLog.innerHTML = "";
          const welcome = document.createElement("div");
          welcome.className = "chat-entry bot-message";
          const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
          welcome.innerHTML = `<span>ü§ñ Skyebot [${time}]: Hello! How can I assist you today?</span>`;
          chatLog.appendChild(welcome);
        }
        if (promptInput) promptInput.value = "";
        if (fileInput) fileInput.value = "";
        if (fileInfo) fileInfo.textContent = "No files selected";
      }
      // #endregion
      modal.style.display = isVisible ? "none" : "block";
      document.body.classList.toggle("modal-open", !isVisible);
    }
    // #endregion

    // #region üìÅ File Input Info
    function updateFileLabel(input) {
      const info = document.getElementById("fileInfo");
      if (!info) return;
      if (input.files.length === 0) info.textContent = "No files selected";
      else if (input.files.length === 1) info.textContent = input.files[0].name;
      else info.textContent = `${input.files.length} files selected`;
    }
    // #endregion

    // #region üñ±Ô∏è Modal Dismiss On Background Click
    window.addEventListener("click", function (event) {
      const modal = document.getElementById("skyebotModal");
      if (event.target === modal) {
        modal.style.display = "none";
        document.body.classList.remove("modal-open");
      }
    });
    // #endregion

    // #region üìä DataTable Initialization
    $(document).ready(function () {
      $('#projectTable').DataTable({
        paging: false,
        searching: false,
        info: false,
        scrollY: '160px',
        scrollCollapse: true
      });
    });
    // #endregion

    // #region üîê Session Manager & Login State
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof window.updateLoginUI === "function") window.updateLoginUI();
    });
    // #endregion

    // #region üßπ Clear Chat/File Inputs
    document.getElementById("clearBtn")?.addEventListener("click", () => {
      const promptInput = document.getElementById("promptInput");
      const fileInput = document.getElementById("fileUpload");
      const fileInfo = document.getElementById("fileInfo");
      if (promptInput) promptInput.value = "";
      if (fileInput) fileInput.value = "";
      if (fileInfo) fileInfo.textContent = "No files selected";
    });
    // #endregion

    // #region üíæ Save Structured Chat Log
    function saveStructuredChatLog() {
      const entries = [];
      document.querySelectorAll("#chatLog .chat-entry").forEach(entry => {
        const text = entry.textContent.trim();
        const role = entry.classList.contains("user-message") ? "user" : "bot";
        entries.push({ role, text });
      });
      fetch("/skyesoft/api/saveChatLog.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ log: entries })
      })
      .then(res => res.json())
      .then(data => console.log("üìù Chat log saved:", data))
      .catch(err => console.error("‚ùå Failed to save chat log:", err));
    }
    // #endregion

    // #region üßÆ Format Duration Utility
    function formatDurationPadded(seconds) {
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400) / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      const parts = [];
      if (d > 0) parts.push(`${d}d`);
      if (h > 0 || d > 0) parts.push(`${String(h).padStart(2, '0')}h`);
      if (m > 0 || h > 0 || d > 0) parts.push(`${String(m).padStart(2, '0')}m`);
      parts.push(`${String(s).padStart(2, '0')}s`);
      return parts.join(" ");
    }
    // #endregion

    // #region üß© Centralized UI Update (Login/Logout/Modal Fade)
    window.updateLoginUI = function() {
      const loginWrapper = document.querySelector('.login-wrapper');
      const dashboard = document.getElementById('dashboardSection');
      const newsUpdates = document.querySelector('.news-updates');
      const projectSummary = document.querySelector("#projectTable")?.closest(".board-panel");
      const header = document.getElementById("bodyHeaderCopy");
      const floatingBtn = document.getElementById('floatingChatBtn');
      const skyebotModal = document.getElementById('skyebotModal');
      const isLoggedIn = !!localStorage.getItem('userLoggedIn') && !!document.cookie.match(/skyelogin_user=/);

      if (isLoggedIn) {
        if (loginWrapper) loginWrapper.style.display = "none";
        if (dashboard) dashboard.style.display = "block";
        if (newsUpdates) newsUpdates.style.display = "block";
        if (projectSummary) projectSummary.style.display = "block";
        if (header) header.textContent = "üìã Project Dashboard";
        if (floatingBtn) floatingBtn.style.display = "block";
      } else {
        if (loginWrapper) loginWrapper.style.display = "flex";
        if (dashboard) dashboard.style.display = "none";
        if (newsUpdates) newsUpdates.style.display = "none";
        if (projectSummary) projectSummary.style.display = "none";
        if (header) header.textContent = "üîí User Log In";
        if (floatingBtn) floatingBtn.style.display = "none";
        // ‚ú® Close Skyebot modal with fade-out if open
        if (skyebotModal && skyebotModal.style.display === "block") {
          skyebotModal.classList.add("fade-out");
          document.body.classList.remove("modal-open");
          setTimeout(() => {
            skyebotModal.style.display = "none";
            skyebotModal.classList.remove("fade-out");
          }, 400); // Match your CSS transition duration
        }
      }
      // Add any other session-dependent UI updates here!
    };
    // #endregion

    // #region üè∑Ô∏è CRUD ActionTypeID Utility
    /**
     * Utility: Extracts actionTypeID from button class, e.g., "crud1" => 1
     * @param {HTMLElement} element - Button element to inspect
     * @returns {number|null} - The actionTypeID or null if not found
     */
    function getCrudActionTypeID(element) {
      const match = Array.from(element.classList).find(c => c.startsWith('crud'));
      return match ? parseInt(match.replace('crud', ''), 10) : null;
    }
    // #endregion

    // #region üìù Centralized CRUD Action Logger
    /**
     * Adds a CRUD action object to the provided actions array.
     * @param {Array} actionsArray - The array to append the new action to
     * @param {Object} params - Parameters for the action (see schema)
     * @returns {Object} - The newly created action object
     */
    function addAction(actionsArray, params) {
      const nextId = actionsArray.length > 0
        ? Math.max(...actionsArray.map(a => a.actionID)) + 1
        : 1;
      const now = Date.now(); // <-- Unix timestamp (milliseconds)
      const newAction = {
        actionID: nextId,
        actionTypeID: params.actionTypeID,
        entityID: params.entityID || null,
        projectID: params.projectID || null,
        locationID: params.locationID || null,
        contactID: params.contactID,
        assignedTo: params.assignedTo || params.contactID,
        dueDate: params.dueDate || null,
        completedDate: params.completedDate || null,
        status: params.status || "open",
        priority: params.priority || "normal",
        notes: params.notes || "",
        createdAt: now,
        updatedAt: now
      };
      actionsArray.push(newAction);
      console.log("Action added:", newAction);  // <-- THIS LINE
      return newAction;
    }
    // #endregion

    // #region üîë Login Form Handler (with CRUD Logging)
    document.querySelector(".login-form")?.addEventListener("submit", (e) => {
      e.preventDefault();

      // Find the submit button with a crudX class
      const btn = e.submitter || document.querySelector(".crud1");
      const actionTypeID = getCrudActionTypeID(btn);

      // Load actions array from storage
      let actions = [];
      try { actions = JSON.parse(localStorage.getItem("actions")) || []; } catch { actions = []; }

      // Call addAction with login params
      addAction(actions, {
        actionTypeID: actionTypeID, // From the button class, e.g. 1
        entityID: 1,
        locationID: 1,
        contactID: 1, // Set dynamically if you have multiple users
        notes: "User logged in",
        status: "completed"
      });

      // Save updated actions array
      localStorage.setItem("actions", JSON.stringify(actions));
      localStorage.setItem("userLoggedIn", "true");
    
    });
    // #endregion

  </script>
  <!-- #endregion -->
  
  <!-- #region ü§ñ Skyebot Script -->
  <script src="assets/js/skyebot.js"></script>
  <!-- #endregion -->

</body>
<!-- #endregion -->
</html>