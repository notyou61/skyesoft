<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Office Bulletin Board</title>
<link rel="icon" href="/skyesoft/assets/images/favicon.ico" type="image/x-icon">

<!-- ============================================== -->
<!--  OfficeBoard v8.2 â€” Codex-Compliant UI Layer   -->
<!-- ============================================== -->

<style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
        height:100vh;
        font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
        background:url('/skyesoft/assets/images/background.jpg') no-repeat center center fixed;
        background-size:cover;
        display:flex;flex-direction:column;align-items:center;
    }
    .board-section{
        width:90vw;max-width:1200px;background:#fff;border-radius:12px;
        box-shadow:0 4px 12px rgba(0,0,0,0.1);padding:8px 16px
    }
    #pageHeader,#pageFooter{flex-shrink:0}
    #pageBody{flex-grow:1;display:flex;flex-direction:column;justify-content:space-between;margin:12px 0;max-height:calc(100vh - 160px);overflow:hidden}
    #pageHeader{display:flex;justify-content:space-between;align-items:center;font-size:1.1em;margin-top:12px}
    #bodyHeader,#bodyFooter{font-weight:bold;font-size:1em;text-align:left;margin-bottom:8px}
    #bodyMain{flex-grow:1;display:flex;flex-direction:column;overflow:hidden;margin-top:-4px}
    .entry{margin:6px 0;font-size:1.05em}
    #pageFooter{display:flex;justify-content:space-between;align-items:center;font-size:0.8em;padding:6px 12px;background:#fff;margin-bottom:12px}
    .cardBody{overflow-y:auto;max-height:60vh;flex-grow:1;padding-top:0;margin-top:0}
    .bodyHeader::after{content:"";display:block;height:2px;width:100%;background:#ccc;margin-top:6px}
    .bodyFooter::before{content:"";display:block;height:2px;width:100%;background:#ccc;margin-bottom:6px}
    .version{font-size:0.8em;color:#777}

    .forecastRow{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .forecastItem{flex:1;font-size:0.8rem;min-width:200px;background:#f9f9f9;padding:10px;border-radius:8px;margin:4px 0}

    /* ======================================= */
    /* Active Permits â€” JSON Table            */
    /* ======================================= */

    .permitCard{max-height:500px;overflow:hidden;width:100%}
    .scrollContainer{max-height:400px;overflow-y:auto;position:relative;width:100%}
    .permitTable{width:100%;border-collapse:collapse;table-layout:auto}
    .permitTable thead{position:sticky;top:0;background:#004080;color:#fff;z-index:2}
    .permitTable th,.permitTable td{padding:6px 8px;border-bottom:1px solid #ddd;text-align:left}
    .permitTable tr:nth-child(even){background:#f2f2f2}
    .status-ready{color:green;font-weight:bold}
    .status-review{color:orange;font-weight:bold}
</style>
</head>
<body>

<!-- ============================================== -->
<!-- HEADER                                         -->
<!-- ============================================== -->

<div class="board-section" id="pageHeader">
  <div style="display:flex;align-items:center;gap:16px">
    <img alt="Christy Signs" src="/skyesoft/assets/images/christyLogo.png" style="max-height:48px">
    <h1 style="font-size:1.4em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Office Bulletin Board</h1>
  </div>
  <div style="display:flex;flex-direction:column;align-items:flex-end;font-size:0.9em;white-space:nowrap">
    <div>Weather: <span id="weatherDisplay">Loading...</span></div>
    <div>Time: <span id="currentTime">--:--:--</span></div>
    <div>Interval: <span id="intervalRemainingData">Loading...</span></div>
  </div>
</div>

<!-- ============================================== -->
<!-- BODY                                           -->
<!-- ============================================== -->

<div class="board-section" id="pageBody">
  <div class="bodyHeader" id="bodyHeader"></div>
  <div id="bodyMain"></div>
  <div class="bodyFooter" id="bodyFooter"></div>
</div>

<!-- ============================================== -->
<!-- FOOTER (Version from getVersions.php)          -->
<!-- ============================================== -->

<div class="board-section" id="pageFooter">
  <div>Â© 2025 Maychris Corporation</div>
  <div class="version" id="versionDisplay">Loading versionsâ€¦</div>
</div>

<!-- ============================================== -->
<!-- JAVASCRIPT â€” OfficeBoard v8.2                  -->
<!-- ============================================== -->

<script>
/* ============================================================
   1. LOAD VERSIONS FROM getVersions.php
   ============================================================ */
function loadVersions() {
  fetch("/skyesoft/api/getVersions.php")
    .then(r=>r.json())
    .then(v=>{
      if(!v.success) return;
      const vb = v.data.modules.officeBoard?.version || "v0.0.X";
      const ap = v.data.modules.activePermits?.version || "v0.0.X";
      const cx = v.data.codex?.version || "?.?";
      document.getElementById("versionDisplay").textContent =
        `OfficeBoard ${vb} | ActivePermits ${ap} | Codex ${cx}`;
    })
    .catch(()=>{});
}

/* ============================================================
   2. LIVE DATA â€” Clock, Weather, Holiday, Intervals
   ============================================================ */

let serverData = null;
let serverTimeOffset = 0;

function loadLiveData() {
  fetch("/skyesoft/api/getDynamicData.php")
    .then(r => r.json())
    .then(d => {
      serverData = d;
      if (d.timeDateArray?.currentUnixTime) {
        serverTimeOffset = (d.timeDateArray.currentUnixTime * 1000) - Date.now();
      }
      updateClock();
      updateIntervalCountdown();
      updateWeatherDisplay(d);
      updateHolidayDisplay(d);
    });
}

function updateClock() {
  if (!serverData) return;
  const serverNow = new Date(Date.now() + serverTimeOffset);

  let h = serverNow.getHours();
  const m = serverNow.getMinutes().toString().padStart(2, "0");
  const s = serverNow.getSeconds().toString().padStart(2, "0");
  const ampm = h >= 12 ? "PM" : "AM";
  h = (h % 12) || 12;

  document.getElementById("currentTime").textContent = `${h}:${m}:${s} ${ampm}`;
}

function updateIntervalCountdown() {
  if (!serverData?.intervalsArray) return;

  const i = serverData.intervalsArray;
  let sec = Math.max(0, i.secondsRemainingToInterval);

  const hh = Math.floor(sec / 3600).toString().padStart(2,"0");
  const mm = Math.floor((sec % 3600) / 60).toString().padStart(2,"0");
  const ss = (sec % 60).toString().padStart(2,"0");

  let label="", emoji="";
  const isWorkday = i.dayType === "Workday";

  if (!isWorkday) { label="Office closed"; emoji="ðŸŸ¦"; }
  else if (i.intervalName==="Worktime") { label="Workday ends in"; emoji="ðŸŸ©"; }
  else if (i.intervalName==="Before Worktime") { label="Workday begins in"; emoji="ðŸŸ¨"; }
  else { label="Workday resumes tomorrow"; emoji="ðŸ”´"; }

  const text = label.includes("in") ? `${emoji} ${label} ${hh}h ${mm}m ${ss}s` : `${emoji} ${label}`;
  document.getElementById("intervalRemainingData").textContent = text;

  serverData.intervalsArray.secondsRemainingToInterval = sec - 1;
}

function updateWeatherDisplay(d) {
  if (!d.weatherData) return;
  const w = d.weatherData;

  const icons={"01":"â˜€ï¸","02":"ðŸŒ¤ï¸","03":"â›…","04":"â˜ï¸","09":"ðŸŒ¦ï¸","10":"ðŸŒ§ï¸","11":"â›ˆï¸","13":"â„ï¸","50":"ðŸŒ«ï¸"};
  const emoji = icons[w.icon?.substr(0,2)] || "ðŸŒ¤ï¸";

  document.getElementById("weatherDisplay").textContent =
    `${emoji} ${w.temp}Â°F â€” ${w.description}`;
}

function updateHolidayDisplay(d) {
  if (!d.holidays) return;
  const today=new Date(); today.setHours(0,0,0,0);
  let closest=Infinity, name="";
  for (let ds in d.holidays) {
    const hd=new Date(ds);
    if (hd>=today) {
      const diff=Math.ceil((hd-today)/86400000);
      if (diff<closest){ closest=diff; name=d.holidays[ds]; }
    }
  }
  if(name) document.getElementById("nextHoliday").textContent=
    `${name} â€” in ${closest} day${closest>1?"s":""}`;
}

/* ============================================================
   3. ACTIVE PERMITS â€” JSON-DRIVEN
   ============================================================ */

function loadActivePermits() {
  fetch("/skyesoft/assets/data/activePermits.json")
    .then(r=>r.json())
    .then(rows=>{
      const body = rows.map(r=>`
        <tr>
          <td>${r.wo}</td>
          <td>${r.customer}</td>
          <td>${r.jobsite}</td>
          <td>${r.jurisdiction}</td>
          <td>${r.fee}</td>
          <td class="${r.status.includes('Review')?'status-review':'status-ready'}">
            ${r.status}
          </td>
        </tr>
      `).join("");

      document.getElementById("permitsTableBody").innerHTML = body;
    })
    .catch(()=>{
      document.getElementById("permitsTableBody").innerHTML =
        `<tr><td colspan="6">Error loading permits.</td></tr>`;
    });
}

/* ============================================================
   4. CARD ROTATION + AUTO-SCROLL
   ============================================================ */

const cards = [
  { key:"permits", header:"<h2>ðŸ“‹ Active Permits</h2>", footer:"<small>Live Data</small>", duration:30000 },
  { key:"highlights", header:"<h2>ðŸŒ… Todayâ€™s Highlights</h2>", footer:"<small>Live Data</small>", duration:30000 },
  { key:"kpi", header:"<h2>ðŸ“ˆ KPI Dashboard</h2>", footer:"<small>Updated Daily</small>", duration:30000 },
  { key:"ann", header:"<h2>ðŸ“¢ Announcements</h2>", footer:"<small>Company-Wide</small>", duration:30000 }
];

let cardIndex=0;

function renderCard() {
  const c = cards[cardIndex];

  document.getElementById("bodyHeader").innerHTML = c.header;
  document.getElementById("bodyFooter").innerHTML = c.footer;

  if (c.key==="permits") {
    document.getElementById("bodyMain").innerHTML = `
      <div class="cardBody">
        <div class="permitCard">
          <div class="scrollContainer">
            <table class="permitTable">
              <thead>
                <tr>
                  <th>WO #</th><th>Customer</th><th>Jobsite</th>
                  <th>Jurisdiction</th><th>Fee</th><th>Status</th>
                </tr>
              </thead>
              <tbody id="permitsTableBody">
                <tr><td colspan="6">Loadingâ€¦</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
    loadActivePermits();
    setTimeout(autoScrollPermits,500);

  } else if (c.key==="highlights") {
    document.getElementById("bodyMain").innerHTML = `
      <div class="cardBody">
        <div class="entry">ðŸ“… <span id="todaysDate"></span>
          Â· Day <span id="dayOfYear"></span> of 365
          (<span id="daysRemaining"></span> remaining)</div>
        <div class="entry">ðŸŒ„ Sunrise: <span id="sunriseTime">--</span>
          Â· ðŸŒ‡ Sunset: <span id="sunsetTime">--</span></div>
        <div class="entry">ðŸ•’ Daylight: <span id="daylightTime">--</span>
          Â· ðŸŒŒ Night: <span id="nightTime">--</span></div>
        <div class="entry">Next Holiday: <span id="nextHoliday">Loading...</span></div>
      </div>
    `;
    updateHighlights();

  } else if (c.key==="kpi") {
    document.getElementById("bodyMain").innerHTML =
      `<div class="cardBody"><div class="entry">Coming Soonâ€¦</div></div>`;

  } else {
    document.getElementById("bodyMain").innerHTML =
      `<div class="cardBody"><div class="entry">No announcements posted.</div></div>`;
  }

  cardIndex = (cardIndex+1) % cards.length;
  setTimeout(renderCard, c.duration);
}

function autoScrollPermits() {
  const cont=document.querySelector(".scrollContainer");
  if(!cont) return;
  cont.scrollTop=0;
  const dist = cont.scrollHeight - cont.clientHeight;
  if(dist<=0) return;

  const scrollTime = cards[0].duration - 2000;
  const step = dist / (scrollTime / 30);
  let pos=0;

  const timer=setInterval(()=>{
    pos+=step;
    cont.scrollTop=pos;
    if(pos>=dist) clearInterval(timer);
  },30);
}

/* ============================================================
   5. HIGHLIGHTS HELPER
   ============================================================ */
function updateHighlights() {
  const n=new Date();
  const f=n.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const y=n.getFullYear();
  const leap=(y%4===0&&(y%100!==0||y%400===0))?366:365;
  const doy=Math.floor((n-new Date(y,0,0))/86400000);
  document.getElementById("todaysDate").textContent=f;
  document.getElementById("dayOfYear").textContent=doy;
  document.getElementById("daysRemaining").textContent=leap-doy;
}

/* ============================================================
   6. INIT
   ============================================================ */
window.addEventListener("DOMContentLoaded",()=>{
  loadVersions();
  loadLiveData();
  setInterval(loadLiveData,15000);
  setInterval(updateClock,1000);
  setInterval(updateIntervalCountdown,1000);
  renderCard();
});
</script>

</body>
</html>