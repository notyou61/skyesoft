<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Office Bulletin Board</title>
<link rel="icon" href="/skyesoft/assets/images/favicon.ico" type="image/x-icon">

<style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
        height:100vh;
        font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
        background:url('/skyesoft/assets/images/background.jpg') no-repeat center center fixed;
        background-size:cover;
        display:flex;
        flex-direction:column;
        align-items:center;
    }
    .board-section{
        width:90vw;
        max-width:1200px;
        background:#fff;
        border-radius:12px;
        box-shadow:0 4px 12px rgba(0,0,0,0.1);
        padding:8px 16px
    }
    #pageHeader,#pageFooter{flex-shrink:0}
    #pageBody{
        flex-grow:1;
        display:flex;
        flex-direction:column;
        justify-content:space-between;
        margin:12px 0;
        max-height:calc(100vh - 160px);
        overflow:hidden
    }
    #pageHeader{
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:1.1em;
        margin-top:12px
    }
    #bodyHeader,#bodyFooter{
        font-weight:bold;
        font-size:1em;
        text-align:left;
        margin-bottom:8px
    }
    #bodyMain{
        flex-grow:1;
        display:flex;
        flex-direction:column;
        justify-content:flex-start;
        overflow:hidden;
        margin-top:-4px
    }
    .entry{margin:6px 0;font-size:1.05em}
    #pageFooter{
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:0.8em;
        padding:6px 12px;
        background:#fff;
        margin-bottom:12px
    }
    .version{font-size:0.8em;color:#777}
    .forecastRow{
        display:flex;
        justify-content:space-between;
        gap:12px;
        flex-wrap:wrap
    }
    .forecastItem{
        flex:1;
        font-size:0.8rem;
        min-width:200px;
        background:#f9f9f9;
        padding:10px;
        border-radius:8px;
        margin:4px 0
    }
    .permitCard{max-height:500px;overflow:hidden;width:100%}
    .scrollContainer{max-height:400px;overflow-y:auto;position:relative;width:100%}
    .permitTable{width:100%;border-collapse:collapse;table-layout:auto}
    .permitTable thead{position:sticky;top:0;background:#004080;color:#fff;z-index:2}
    .permitTable th,.permitTable td{
        padding:6px 8px;
        border-bottom:1px solid #ddd;
        text-align:left
    }
    .permitTable tr:nth-child(even){background:#f2f2f2}
    .status-ready{color:green;font-weight:bold}
    .status-review{color:orange;font-weight:bold}
</style>
</head>

<body>

<!-- =========================================================== -->
<!-- HEADER -->
<!-- =========================================================== -->
<div class="board-section" id="pageHeader">
  <div style="display:flex;align-items:center;gap:16px">
    <img alt="Christy Signs" src="/skyesoft/assets/images/christyLogo.png" style="max-height:48px">
    <h1 style="font-size:1.4em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Office Bulletin Board</h1>
  </div>

  <div style="display:flex;flex-direction:column;align-items:flex-end;font-size:0.9em;white-space:nowrap">
    <div>Weather: <span id="weatherDisplay">Loading...</span></div>
    <div>Time: <span id="currentTime">--:--:--</span></div>
    <div>Interval: <span id="intervalRemainingData">Loading...</span></div>
  </div>
</div>

<!-- =========================================================== -->
<!-- BODY -->
<!-- =========================================================== -->
<div class="board-section" id="pageBody">
  <div class="bodyHeader" id="bodyHeader"></div>
  <div id="bodyMain"></div>
  <div class="bodyFooter" id="bodyFooter"></div>
</div>

<!-- =========================================================== -->
<!-- FOOTER -->
<!-- =========================================================== -->
<div class="board-section" id="pageFooter">
  <div>¬© 2025 Maychris Corporation</div>
  <div class="version" id="versionFooter">v8.2 ‚Äî Loading versions‚Ä¶</div>
</div>

<script>
// ===================================================================
// SAFETY WRAPPER ‚Äî prevents null-target crashes
// ===================================================================
function safeSet(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

// ===================================================================
// LOAD VERSION DATA (Codex Standard B-10)
// ===================================================================
function updateVersionFooterFromSSE(d) {
  try {
    if (!d.versions) {
      safeSet("versionFooter", "Version info unavailable");
      return;
    }

    const v = d.versions;

    const vb = v.modules.officeBoard.version;
    const vp = v.modules.activePermits.version;
    const codex = v.codex.version;

    safeSet("versionFooter", `OfficeBoard ${vb} ‚Ä¢ ActivePermits ${vp} ‚Ä¢ Codex ${codex}`);
  } catch (e) {
    safeSet("versionFooter", "Version info unavailable");
  }
}


// ===================================================================
// LIVE DATA LOAD (SSE-like fetch)
// ===================================================================
let serverData = null;
let serverTimeOffset = 0;

function loadLiveData() {
  fetch("/skyesoft/api/getDynamicData.php")
    .then(r => r.json())
    .then(d => {
      // STORE FOR GLOBAL ACCESS
      serverData = d;
      // VERSION FOOTER
      updateVersionFooterFromSSE(d);
      // TIME SYNC
      if (d?.timeDateArray?.currentUnixTime) {
        serverTimeOffset = (d.timeDateArray.currentUnixTime * 1000) - Date.now();
      }
      // CLOCK UPDATE
      updateClock();
      // WEATHER
      if (d.weatherData) {
        const w = d.weatherData;
        const icons = {"01":"‚òÄÔ∏è","02":"üå§Ô∏è","03":"‚õÖ","04":"‚òÅÔ∏è","09":"üå¶Ô∏è","10":"üåßÔ∏è","11":"‚õàÔ∏è","13":"‚ùÑÔ∏è","50":"üå´Ô∏è"};
        const emoji = icons[w.icon?.substring(0,2)] || "üå§Ô∏è";

        safeSet("weatherDisplay", `${emoji} ${w.temp}¬∞F ‚Äî ${w.description}`);
        safeSet("sunriseTime", w.sunrise);
        safeSet("sunsetTime", w.sunset);
        safeSet("daylightTime", w.daytimeHours);
        safeSet("nightTime", w.nighttimeHours);

        if (Array.isArray(w.forecast)) {
          w.forecast.slice(0,3).forEach((day, i) => {
            const el = document.getElementById("forecastDay"+(i+1));
            if (!el) return;
            const em = icons[day.icon?.substring(0,2)] || "üå§Ô∏è";
            const desc = day.description[0].toUpperCase() + day.description.slice(1);

            el.innerHTML = `
              <strong>üìÖ ${day.date}</strong><br>
              ${em} ${desc}<br>
              High ${day.high}¬∞F / Low ${day.low}¬∞F |
              üíß ${day.precip}% | üí® ${day.wind} mph
            `;
          });
        }
      }

      // HOLIDAYS (patched: no crash if element missing)
      if (d.holidays) {
        const today = new Date(); today.setHours(0,0,0,0);
        let closest = Infinity;
        let name = "";

        for (let ds in d.holidays) {
          const hd = new Date(ds);
          if (hd >= today) {
            const diff = Math.ceil((hd - today)/86400000);
            if (diff < closest) {
              closest = diff;
              name = d.holidays[ds];
            }
          }
        }

        const el = document.getElementById("nextHoliday");
        if (el) {
          el.textContent = `${name} ‚Äî in ${closest} day${closest>1?"s":""}`;
        }
      }

    })
    .catch(() => {});
}

// ===================================================================
// CLOCK + INTERVALS
// ===================================================================
function updateClock() {
  if (!serverData) return;

  const now = new Date(Date.now() + serverTimeOffset);
  const h = now.getHours();
  const m = now.getMinutes().toString().padStart(2,'0');
  const s = now.getSeconds().toString().padStart(2,'0');
  const am = (h>=12?"PM":"AM");
  safeSet("currentTime", `${(h%12)||12}:${m}:${s} ${am}`);

  if (serverData.intervalsArray) {
    let sec = Math.max(0, serverData.intervalsArray.secondsRemainingToInterval);
    const hh = Math.floor(sec/3600).toString().padStart(2,'0');
    const mm = Math.floor((sec%3600)/60).toString().padStart(2,'0');
    const ss = (sec%60).toString().padStart(2,'0');

    const i = serverData.intervalsArray;
    let label="", emoji="";

    if (i.dayType !== "Workday") {
      label = "Office closed"; emoji = "üü¶";
    } else if (i.intervalName === "Worktime") {
      label = "Workday ends in"; emoji="üü©";
    } else if (i.intervalName === "Before Worktime") {
      label="Workday begins in"; emoji="üü®";
    } else {
      label="Workday resumes tomorrow"; emoji="üî¥";
    }

    const msg = label.includes("in")
      ? `${emoji} ${label} ${hh}h ${mm}m ${ss}s`
      : `${emoji} ${label}`;

    safeSet("intervalRemainingData", msg);

    serverData.intervalsArray.secondsRemainingToInterval = sec - 1;
  }
}

// ===================================================================
// ACTIVE PERMITS LOADER (JSON-driven)
// ===================================================================
async function loadPermitData() {
  try {
    const res = await fetch("/skyesoft/assets/data/activePermits.json");
    const json = await res.json();
    const tbody = document.getElementById("permitTableBody");
    if (!tbody) return;

    if (!json.activePermits) {
      tbody.innerHTML = `<tr><td colspan="6">Error: no data found</td></tr>`;
      return;
    }

    tbody.innerHTML = json.activePermits.map(p => `
      <tr>
        <td>${p.wo}</td>
        <td>${p.customer}</td>
        <td>${p.jobsite}</td>
        <td>${p.jurisdiction}</td>
        <td>$${p.fee.toFixed(2)}</td>
        <td class="${p.status.includes("Review")?"status-review":"status-ready"}">
          ${p.status}
        </td>
      </tr>
    `).join("");

  } catch (e) {
    safeSet("permitTableBody", `<tr><td colspan="6">Error loading permit data</td></tr>`);
  }
}

// ===================================================================
// TODAY'S HIGHLIGHTS CARD HELPERS
// ===================================================================
function getDateInfo() {
  const n=new Date();
  const f=n.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const y=n.getFullYear();
  const leap=(y%4===0 && (y%100!==0 || y%400===0)) ? 366 : 365;
  const doy=Math.floor((n-new Date(y,0,0))/86400000);
  return {formattedDate:f, dayOfYear:doy, daysRemaining:leap-doy};
}

function updateHighlightsCard() {
  const d = getDateInfo();
  safeSet("todaysDate", d.formattedDate);
  safeSet("dayOfYear", d.dayOfYear);
  safeSet("daysRemaining", d.daysRemaining);
}

// ===================================================================
// CARD ROTATION + SCROLL
// ===================================================================
const cards = [
  {
    header:"<h2>üìã Active Permits</h2>",
    body:`<div class="permitCard">
            <div class="scrollContainer">
              <table class="permitTable">
                <thead>
                  <tr>
                    <th>WO #</th><th>Customer</th><th>Jobsite</th>
                    <th>Jurisdiction</th><th>Fee</th><th>Status</th>
                  </tr>
                </thead>
                <tbody id="permitTableBody"><tr><td colspan="6">Loading...</td></tr></tbody>
              </table>
            </div>
          </div>`,
    footer:"<small>Active Permits</small>",
    duration:30000
  },
  {
    header:"<h2>üåÖ Today‚Äôs Highlights</h2>",
    body:`<div class="entry">üìÖ <span id="todaysDate"></span> ¬∑ Day <span id="dayOfYear"></span> of 365 (<span id="daysRemaining"></span> remaining)</div>
          <div class="entry">üåÑ Sunrise: <span id="sunriseTime">--</span> ¬∑ üåá Sunset: <span id="sunsetTime">--</span></div>
          <div class="entry">üïí Daylight: <span id="daylightTime">--</span> ¬∑ üåå Night: <span id="nightTime">--</span></div>
          <div class="entry">Next Holiday: <span id="nextHoliday">Loading...</span></div>
          <hr style="margin:12px 0;border:none;border-top:1px solid #ccc">
          <div class="entry" id="tipOfTheDay">üí° Tip of the Day: Loading...</div>
          <hr>
          <div class="forecastRow">
            <div class="forecastItem"><span id="forecastDay1">Loading...</span></div>
            <div class="forecastItem"><span id="forecastDay2">Loading...</span></div>
            <div class="forecastItem"><span id="forecastDay3">Loading...</span></div>
          </div>`,
    footer:"<small>Live Data</small>",
    duration:30000
  },
  {
    header:"<h2>üìà KPI Dashboard</h2>",
    body:`<div class="entry">Coming Soon...</div>`,
    footer:"<small>Updated Daily</small>",
    duration:30000
  },
  {
    header:"<h2>üì¢ Announcements</h2>",
    body:`<div class="entry">No announcements posted.</div>`,
    footer:"<small>Company-Wide</small>",
    duration:30000
  }
];

let cardIndex = 0;

function populateCard(c){
  // HEADER
  const headerEl = document.getElementById("bodyHeader");
  if (headerEl) headerEl.innerHTML = c.header;
  // BODY
  document.getElementById("bodyMain").innerHTML = `<div class="cardBody">${c.body}</div>`;
  // FOOTER
  const footerEl = document.getElementById("bodyFooter");
  if (footerEl) footerEl.innerHTML = c.footer;
}

function autoScrollActivePermits() {
  const container = document.querySelector(".scrollContainer");
  if (!container) return;

  container.scrollTop = 0;
  const dist = container.scrollHeight - container.clientHeight;
  if (dist <= 0) return;

  const buffer = 2000; // stop 2s early
  const scrollTime = cards[0].duration - buffer;
  const step = dist / (scrollTime / 30);
  let pos = 0;

  const t = setInterval(() => {
    pos += step;
    container.scrollTop = pos;
    if (pos >= dist) clearInterval(t);
  }, 30);
}

function rotateCards() {
  const c = cards[cardIndex];
  populateCard(c);

  if (cardIndex === 0) {
    setTimeout(loadPermitData, 50);
    setTimeout(autoScrollActivePermits, 500);
  }

  if (cardIndex === 1) {
    setTimeout(updateHighlightsCard, 50);
  }

  cardIndex = (cardIndex + 1) % cards.length;
  setTimeout(rotateCards, c.duration);
}

// ===================================================================
// START
// ===================================================================
loadLiveData();

setInterval(loadLiveData, 15000);
setInterval(updateClock, 1000);

window.addEventListener("DOMContentLoaded", rotateCards);
</script>

</body>
</html>