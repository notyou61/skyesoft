<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Skyesoft — Streamed List Test Surface</title>

<link rel="stylesheet" href="/skyesoft/assets/css/skyesoft-ui.css">
<link rel="stylesheet" href="/skyesoft/assets/css/indexPage.css">
</head>

<body>

<div class="roadmap">
  <div class="roadmap-header">
    <h2 id="domainTitle">Loading…</h2>
    <a href="#" class="create-link">＋ Create</a>
  </div>

  <!-- Generic streamed list container -->
  <div id="outlineContainer"></div>
</div>

<script type="module">
/* ============================================================
 *  Generic Streamed List Surface
 * ============================================================ */

import { adaptStreamedDomain } from '/skyesoft/assets/js/domainAdapter.js';

/* ---- Config ------------------------------------------------ */

const domainKey = 'roadmap';
const domainUrl = '/skyesoft/data/authoritative/roadmap.json';
const presentationUrl = '/skyesoft/data/authoritative/presentationRegistry.json';

/* ---- Bootstrap -------------------------------------------- */

Promise.all([
  fetch(domainUrl).then(r => r.json()),
  fetch(presentationUrl).then(r => r.json())
]).then(([domainData, presentationRegistry]) => {

  const adapted = adaptStreamedDomain(domainKey, domainData);
  if (!adapted) {
    console.error('Domain adaptation failed');
    return;
  }

  document.getElementById('domainTitle').textContent = adapted.title;

  const presentation = presentationRegistry.domains[domainKey];
  renderOutline(adapted.nodes, presentation);

});

/* ---- Renderer --------------------------------------------- */

function renderOutline(nodes, presentation) {
  const container = document.getElementById('outlineContainer');
  container.innerHTML = '';

  nodes.forEach(node => {
    container.appendChild(renderNode(node, presentation));
  });
}

function renderNode(node, presentation) {

  const nodeType = node.children ? 'phase' : 'task';
  const rules = resolvePresentation(presentation, nodeType);

  const wrapper = document.createElement('div');
  wrapper.className = nodeType;

  const header = document.createElement('div');
  header.className = `${nodeType}-header`;
  header.textContent = node.label;

  /* Status badge (if present) */
  if (node.status) {
    const status = document.createElement('span');
    status.className = `status ${node.status}`;
    status.textContent =
      node.status === 'complete' ? '✓ Complete' :
      node.status === 'in-progress' ? '⏳ In Progress' :
      'Pending';
    header.appendChild(status);
  }

  /* Edit link */
  if (rules.editable) {
    const edit = document.createElement('a');
    edit.href = '#';
    edit.className = 'edit-link';
    edit.textContent = 'Edit';
    edit.onclick = e => editPhase(e, node);
    header.appendChild(edit);
  }

  wrapper.appendChild(header);

  /* Children */
  if (node.children?.length) {
    const list = document.createElement('ul');
    list.className = 'tasks';
    list.style.display = rules.defaultExpanded ? 'block' : 'none';

    node.children.forEach(child => {
      const li = document.createElement('li');
      li.textContent = child.label;
      list.appendChild(li);
    });

    if (rules.collapsible) {
      header.onclick = () => {
        list.style.display =
          list.style.display === 'block' ? 'none' : 'block';
      };
    }

    wrapper.appendChild(list);
  }

  return wrapper;
}

/* ---- Presentation Resolver -------------------------------- */

function resolvePresentation(domainConfig, nodeType) {
  return {
    ...domainConfig.defaults,
    ...domainConfig.nodeTypes[nodeType]
  };
}

/* ---- Modal Wiring (unchanged contract) -------------------- */

function editPhase(event, node) {
  event.preventDefault();
  event.stopPropagation();

  document.getElementById('editModalHeaderName').textContent = node.label;
  document.getElementById('editPhaseId').value = node.id;
  document.getElementById('editPhaseName').value = node.label;
  document.getElementById('editPhaseStatus').value = node.status ?? '';
  document.getElementById('editPhaseOutput').value = '';

  document.getElementById('editModal').style.display = 'block';
}

window.closeEditModal = function () {
  document.getElementById('editModal').style.display = 'none';
};

window.savePhaseEdits = function () {
  closeEditModal();
  alert('Edit saved (test surface only)');
};
</script>

<!-- =======================
     Modal (PRESERVED)
======================= -->
<div id="editModal"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000;">

  <div class="bodyPanel" style="max-width:640px; margin:8vh auto; max-height:84vh;">

    <div class="bodyHeader">
      <div class="bodyTitle">
        <strong>Edit Phase</strong> — <span id="editModalHeaderName"></span>
      </div>
    </div>

    <div class="bodyDivider"></div>

    <div class="bodyContent">
      <input type="hidden" id="editPhaseId">

      <label>Phase Name</label>
      <input id="editPhaseName" class="form-control">

      <label>Status</label>
      <select id="editPhaseStatus" class="form-control">
        <option value="complete">Complete</option>
        <option value="in-progress">In Progress</option>
        <option value="pending">Pending</option>
      </select>

      <label>Output Summary</label>
      <textarea id="editPhaseOutput" rows="4" class="form-control"></textarea>
    </div>

    <div class="bodyDivider"></div>

    <div class="bodyFooter">
      <button class="btn" onclick="closeEditModal()">Cancel</button>
      <button class="btn" onclick="savePhaseEdits()">Save</button>
    </div>

  </div>
</div>

</body>
</html>