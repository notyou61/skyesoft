<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Skyesoft Roadmap – Test View</title>

<link rel="stylesheet" href="/skyesoft/assets/css/skyesoft-ui.css">
<link rel="stylesheet" href="/skyesoft/assets/css/indexPage.css">
</head>

<body>

<div class="roadmap">
  <div class="roadmap-header">
    <h2>Skyesoft Roadmap</h2>
    <a href="#" class="create-link">＋ Create Phase</a>
  </div>

  <!-- Roadmap rendered here -->
  <div id="roadmapContainer"></div>
</div>

<script>
/* ----------------------------------------
   Load authoritative roadmap + presentation
----------------------------------------- */
Promise.all([
  fetch("/skyesoft/data/authoritative/roadmap.json").then(r => r.json()),
  fetch("/skyesoft/data/authoritative/presentation.json").then(r => r.json())
]).then(([roadmap, presentation]) => {
  renderRoadmap(roadmap, presentation);
});

/* ----------------------------------------
   Renderer
----------------------------------------- */
function renderRoadmap(roadmap, presentation) {
  const container = document.getElementById("roadmapContainer");
  container.innerHTML = "";

  const domainConfig = presentation.domains.roadmap;
  const phasePresentation = domainConfig.nodeTypes.phase;
  const taskPresentation = domainConfig.nodeTypes.task;

  roadmap.phases.forEach(phase => {
    const phaseEl = document.createElement("div");
    phaseEl.className = "phase";

    /* Phase header */
    const header = document.createElement("div");
    header.className = "phase-header";
    header.textContent = phase.name;

    if (phasePresentation.collapsible) {
      header.onclick = () => {
        tasksEl.style.display =
          tasksEl.style.display === "block" ? "none" : "block";
      };
    }

    /* Status */
    const status = document.createElement("span");
    status.className = `status ${phase.status}`;
    status.textContent =
      phase.status === "complete"
        ? "✓ Complete"
        : phase.status === "in-progress"
        ? "⏳ In Progress"
        : "Pending";
    header.appendChild(status);

    /* Edit link */
    if (phasePresentation.editable) {
      const edit = document.createElement("a");
      edit.href = "#";
      edit.className = "edit-link";
      edit.textContent = "Edit";
      edit.onclick = e => editPhase(e, phase);
      header.appendChild(edit);
    }

    phaseEl.appendChild(header);

    /* Tasks */
    const tasksEl = document.createElement("ul");
    tasksEl.className = "tasks";
    tasksEl.style.display = phasePresentation.defaultExpanded ? "block" : "none";

    phase.tasks.forEach(task => {
      const li = document.createElement("li");
      li.textContent = task;
      tasksEl.appendChild(li);
    });

    phaseEl.appendChild(tasksEl);
    container.appendChild(phaseEl);
  });
}

/* ----------------------------------------
   Modal wiring (unchanged behavior)
----------------------------------------- */
function editPhase(event, phase) {
  event.preventDefault();
  event.stopPropagation();

  document.getElementById("editModalHeaderName").textContent = phase.name;
  document.getElementById("editPhaseId").value = phase.id;
  document.getElementById("editPhaseName").value = phase.name;
  document.getElementById("editPhaseStatus").value = phase.status;
  document.getElementById("editPhaseOutput").value = phase.output;

  document.getElementById("editModal").style.display = "block";
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

function savePhaseEdits() {
  // Test page only — real edits will be governed commands + SSE
  closeEditModal();
  alert("Edit saved (test mode only)");
}
</script>

<!-- Edit Phase Modal (unchanged, already validated) -->
<div id="editModal"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000;">
  <div class="bodyPanel" style="max-width:640px; margin:8vh auto; max-height:84vh;">

    <div class="bodyHeader">
      <div class="bodyTitle">
        <strong>Edit Phase</strong> — <span id="editModalHeaderName"></span>
      </div>
    </div>

    <div class="bodyDivider"></div>

    <div class="bodyContent">
      <input type="hidden" id="editPhaseId">

      <label>Phase Name</label>
      <input id="editPhaseName" class="form-control">

      <label>Status</label>
      <select id="editPhaseStatus" class="form-control">
        <option value="complete">Complete</option>
        <option value="in-progress">In Progress</option>
        <option value="pending">Pending</option>
      </select>

      <label>Output Summary</label>
      <textarea id="editPhaseOutput" rows="4" class="form-control"></textarea>
    </div>

    <div class="bodyDivider"></div>

    <div class="bodyFooter">
      <button class="btn" onclick="closeEditModal()">Cancel</button>
      <button class="btn" onclick="savePhaseEdits()">Save</button>
    </div>

  </div>
</div>

</body>
</html>
