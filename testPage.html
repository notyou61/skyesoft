<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Skyesoft Roadmap – Test View</title>

<link rel="stylesheet" href="/skyesoft/assets/css/skyesoft-ui.css">
<link rel="stylesheet" href="/skyesoft/assets/css/indexPage.css">
</head>

<body>

<div class="roadmap">
  <div class="roadmap-header">
    <h2 id="roadmapTitle">Skyesoft Roadmap</h2>
    <a href="#" class="create-link">＋ Create Phase</a>
  </div>

  <!-- Outline rendered here -->
  <div id="roadmapContainer"></div>
</div>

<!-- =========================================================
     Script (Tier-2 compliant)
========================================================== -->
<script type="module">

/* ----------------------------------------
   Imports
----------------------------------------- */
import {
  adaptStreamedDomain
} from "/skyesoft/assets/js/domainAdapter.js";

/* ----------------------------------------
   Load authoritative data + registry
----------------------------------------- */
Promise.all([
  fetch("/skyesoft/data/authoritative/roadmap.json").then(r => r.json()),
  fetch("/skyesoft/data/authoritative/presentationRegistry.json").then(r => r.json())
]).then(([roadmapData, presentationRegistry]) => {

  const outline = adaptStreamedDomain("roadmap", roadmapData);
  if (!outline) return;

  document.getElementById("roadmapTitle").textContent = outline.title;

  const domainPresentation =
    presentationRegistry.domains.roadmap;

  renderOutline(outline.nodes, domainPresentation);
});

/* ----------------------------------------
   Presentation resolver
----------------------------------------- */
function resolvePresentation(domainConfig, nodeType, nodeMeta = {}) {
  return {
    ...domainConfig.defaults,
    ...domainConfig.nodeTypes[nodeType],
    ...(nodeMeta.presentation || {})
  };
}

/* ----------------------------------------
   Generic outline renderer
----------------------------------------- */
function renderOutline(nodes, domainPresentation) {
  const container = document.getElementById("roadmapContainer");
  container.innerHTML = "";

  nodes.forEach(node =>
    renderNode(node, domainPresentation, container)
  );
}

/* ----------------------------------------
   Recursive node renderer (Workflowy-style)
----------------------------------------- */
function renderNode(node, domainPresentation, parentEl) {

  const nodeType =
    node.children && node.children.length
      ? "phase"
      : "task";

  const presentation =
    resolvePresentation(domainPresentation, nodeType);

  const wrapper = document.createElement("div");
  wrapper.className = nodeType;

  const header = document.createElement("div");
  header.className = `${nodeType}-header`;
  header.textContent = node.label;

  /* Status (phase only) */
  if (node.status) {
    const status = document.createElement("span");
    status.className = `status ${node.status}`;
    status.textContent =
      node.status === "complete"
        ? "✓ Complete"
        : node.status === "in-progress"
        ? "⏳ In Progress"
        : "Pending";
    header.appendChild(status);
  }

  /* Edit action */
  if (presentation.editable) {
    const edit = document.createElement("a");
    edit.href = "#";
    edit.className = "edit-link";
    edit.textContent = "Edit";
    edit.onclick = e => editPhase(e, node);
    header.appendChild(edit);
  }

  wrapper.appendChild(header);

  /* Children */
  if (presentation.collapsible && node.children?.length) {

    const list = document.createElement("ul");
    list.style.display =
      presentation.defaultExpanded ? "block" : "none";

    header.onclick = () => {
      list.style.display =
        list.style.display === "block" ? "none" : "block";
    };

    node.children.forEach(child =>
      renderNode(child, domainPresentation, list)
    );

    wrapper.appendChild(list);
  }

  parentEl.appendChild(wrapper);
}

/* ----------------------------------------
   Modal wiring (preserved)
----------------------------------------- */
function editPhase(event, node) {
  event.preventDefault();
  event.stopPropagation();

  document.getElementById("editModalHeaderName").textContent =
    node.label;

  document.getElementById("editPhaseId").value = node.id;
  document.getElementById("editPhaseName").value = node.label;
  document.getElementById("editPhaseStatus").value = node.status ?? "";
  document.getElementById("editPhaseOutput").value = "";

  document.getElementById("editModal").style.display = "block";
}

window.closeEditModal = function () {
  document.getElementById("editModal").style.display = "none";
};

window.savePhaseEdits = function () {
  closeEditModal();
  alert("Edit saved (test mode only)");
};

</script>

<!-- =========================================================
     Edit Phase Modal (unchanged, validated)
========================================================== -->
<div id="editModal"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000;">
  <div class="bodyPanel"
       style="max-width:640px; margin:8vh auto; max-height:84vh;">

    <div class="bodyHeader">
      <div class="bodyTitle">
        <strong>Edit Phase</strong> —
        <span id="editModalHeaderName"></span>
      </div>
    </div>

    <div class="bodyDivider"></div>

    <div class="bodyContent">
      <input type="hidden" id="editPhaseId">

      <label>Phase Name</label>
      <input id="editPhaseName" class="form-control">

      <label>Status</label>
      <select id="editPhaseStatus" class="form-control">
        <option value="complete">Complete</option>
        <option value="in-progress">In Progress</option>
        <option value="pending">Pending</option>
      </select>

      <label>Output Summary</label>
      <textarea id="editPhaseOutput"
                rows="4"
                class="form-control"></textarea>
    </div>

    <div class="bodyDivider"></div>

    <div class="bodyFooter">
      <button class="btn" onclick="closeEditModal()">Cancel</button>
      <button class="btn" onclick="savePhaseEdits()">Save</button>
    </div>

  </div>
</div>

</body>
</html>
